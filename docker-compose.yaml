services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hookah-db-api
    ports:
      - "3000:3000"
    volumes:
      # Use named volume for SQLite database persistence
      - hookah-db-data:/app/data
    environment:
      # Server configuration
      - NODE_ENV=production
      - PORT=3000
      - SERVICE_NAME=hookah-db
      
      # Database configuration
      - DATABASE_PATH=/app/data/hookah-db.db
      
      # Logging configuration
      - LOG_LEVEL=info
      - LOG_DIR=/app/logs
      
      # Cache configuration
      - CACHE_TTL=86400
      
      # Rate limiting configuration
      - RATE_LIMIT_WINDOW=60000
      - RATE_LIMIT_MAX=100
      
      # Scraping configuration
      - HTREVIEWS_BASE_URL=https://htreviews.org
      - ENABLE_API_EXTRACTION=true
      - API_FLAVORS_PER_REQUEST=20
      - API_REQUEST_DELAY=500
      - API_MAX_RETRIES=3
      - ENABLE_API_FALLBACK=true
      
      # Scheduler configuration
      - SCHEDULER_ENABLED=true
      - CRON_SCHEDULE_BRANDS=0 2 * * *
      - CRON_SCHEDULE_FLAVORS=0 3 * * *
      - CRON_SCHEDULE_ALL=0 4 * * *
      - EXECUTION_HISTORY_LIMIT=100
      
      # API keys (configure in Coolify UI or .env file)
      # - API_KEY_PRODUCTION=f5cc633145ec9995aaa8ba9f889ee472fe3b32c3a6e2793b426ab5f6f198031d
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - hookah-db-network

networks:
  hookah-db-network:
    driver: bridge

volumes:
  # Named volume for SQLite database persistence
  hookah-db-data:
