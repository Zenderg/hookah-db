# Техническое задание: Улучшение поиска по табакам

## Обзор

Документ описывает план улучшения функциональности поиска по табакам для улучшения пользовательского опыта и точности результатов поиска.

## Текущее состояние

### Реализованный функционал

Система поиска использует PostgreSQL Full-Text Search с поддержкой двух языков (русский и английский). Поиск выполняется по трем полям данных:

- Название табака
- Название бренда
- Название линейки

Поиск поддерживает:
- Многословные запросы с логикой "каждое слово должно совпасть хотя бы в одном поле"
- Ранжирование результатов по релевантности
- Стемминг (поиск слов в разных формах)
- Удаление стоп-слов для русского и английского языков

### Выявленные проблемы

На основе анализа пользовательского поведения выявлены следующие проблемы:

1. **Отсутствие поиска по части слова**
   - Ввод "sno" или "snob" не находит бренд "Snobless"
   - Ввод "col" не находит табаки с названием "Cola"
   - Причина: текущая реализация требует точного совпадения слов

2. **Проблемы с комбинациями**
   - Ввод "cola darks" не находит табаки "Cola" от бренда "Darkside"
   - Причина: усеченное слово "darks" не совпадает с "Darkside"

3. **Некорректное ранжирование**
   - При поиске "cola" результат "California Cola" может появляться выше, чем просто "Cola"
   - Причина: алгоритм ранжирования не учитывает точность совпадения и позицию совпадения в названии

## Цели улучшения

### Основные цели

1. Обеспечить поиск по части слова (префиксный поиск)
2. Улучшить ранжирование результатов для отображения наиболее релевантных результатов первыми
3. Сохранить высокую производительность поиска

### Пользовательские сценарии

После улучшений поиск должен корректно обрабатывать следующие сценарии:

- Поиск по началу слова: "sno" → находит "Snobless"
- Поиск по началу слова: "col" → находит "Cola", "Cola Lime", "California Cola"
- Комбинированный поиск: "cola darks" → находит "Cola" от бренда "Darkside"
- Корректное ранжирование при поиске "cola":
  1. "Cola" (точное совпадение всего названия)
  2. "Cola Lime" (совпадение в начале названия)
  3. "California Cola" (совпадение в середине названия)

## Предлагаемое решение

### 1. Префиксный поиск

**Что планируется сделать:**

Добавить поддержку поиска по началу слова для всех поисковых запросов. Вместо требования точного совпадения слова, поиск будет находить все слова, начинающиеся с указанной последовательности символов.

**Зачем это нужно:**

Пользователи часто вводят только начало слова, ожидая увидеть автодополнение или подсказки. Префиксный поиск соответствует естественному поведению пользователей при поиске.

**Как это будет работать:**

- Пользователь вводит "col"
- Система ищет все слова, начинающиеся с "col" (например, "Cola", "Colas", "Colon", "Colorado")
- Результаты ранжируются по релевантности

### 2. Улучшенное ранжирование

**Что планируется сделать:**

Внедрить систему весов для разных типов совпадений, чтобы наиболее релевантные результаты появлялись первыми.

**Зачем это нужно:**

Текущее ранжирование основано только на плотности и позиции совпадений в тексте, но не учитывает точность совпадения. Это приводит к тому, что менее релевантные результаты могут появляться выше в списке.

**Типы совпадений и их веса:**

1. **Точное совпадение названия табака**
   - Определение: поисковый запрос полностью совпадает с названием табака
   - Вес: максимальный
   - Пример: поиск "cola" → "Cola"

2. **Совпадение в начале названия табака**
   - Определение: поисковый запрос совпадает с началом названия табака
   - Вес: высокий
   - Пример: поиск "cola" → "Cola Lime"

3. **Совпадение в середине названия табака**
   - Определение: поисковый запрос совпадает с частью названия табака, но не в начале
   - Вес: базовый (только FTS релевантность)
   - Пример: поиск "cola" → "California Cola"

4. **Совпадения в названии бренда**
   - Определение: поисковый запрос совпадает с названием бренда
   - Вес: средний
   - Пример: поиск "darks" → любой табак от бренда "Darkside"

5. **Совпадения в названии линейки**
   - Определение: поисковый запрос совпадает с названием линейки
   - Вес: средний
   - Пример: поиск "панк" → табаки из линейки "100% Сигарный Панк"

### 3. Алгоритм ранжирования

**Что планируется сделать:**

Реализовать комбинированный алгоритм ранжирования, который суммирует базовую релевантность от Full-Text Search и бонусы за различные типы совпадений.

**Зачем это нужно:**

Комбинированный подход обеспечивает баланс между точностью поиска и скоростью. Full-Text Search обеспечивает быстрый поиск с поддержкой стемминга, а бонусы за точные совпадения обеспечивают корректное ранжирование.

**Как это будет работать:**

1. Вычисляется базовая релевантность через Full-Text Search для всех трех полей
2. Добавляются бонусы за точные совпадения (если применимо)
3. Добавляются бонусы за совпадения в начале названия (если применимо)
4. Результаты сортируются по итоговому рейтингу в убывающем порядке

### 4. Веса для разных полей

**Что планируется сделать:**

Присвоить разные веса для совпадений в разных полях данных.

**Зачем это нужно:**

Название табака является наиболее важным полем для поиска, поэтому совпадения в этом поле должны иметь больший вес, чем совпадения в названии бренда или линейки.

**Распределение весов:**

- Совпадения в названии табака: максимальный вес
- Совпадения в названии бренда: средний вес
- Совпадения в названии линейки: средний вес

## Технические детали

### Производительность

- Префиксный поиск будет использовать существующие GIN индексы для Full-Text Search
- Дополнительные вычисления для ранжирования будут выполняться на уровне базы данных для максимальной производительности
- Ожидается, что время ответа останется в приемлемых пределах (< 100ms для типичных запросов)

### Совместимость

- Изменения будут обратно совместимыми с существующим API
- Параметры запроса останутся без изменений
- Клиентские приложения не потребуют модификаций

### Языковая поддержка

- Будет сохранена поддержка двух языков (русский и английский)
- Префиксный поиск будет работать для обоих языков
- Стемминг будет продолжать работать для обоих языков

## Ожидаемые результаты

### Улучшение пользовательского опыта

1. Пользователи смогут находить табаки, вводя только часть названия
2. Наиболее релевантные результаты будут появляться первыми
3. Поиск будет более предсказуемым и интуитивным

### Примеры улучшений

**До улучшения:**
- Поиск "col" → нет результатов
- Поиск "sno" → нет результатов
- Поиск "cola" → "California Cola" выше, чем "Cola"

**После улучшения:**
- Поиск "col" → "Cola", "Cola Lime", "California Cola" (в порядке релевантности)
- Поиск "sno" → "Snobless" и другие бренды, начинающиеся на "sno"
- Поиск "cola" → "Cola", "Cola Lime", "California Cola" (в порядке релевантности)

## Риски и ограничения

### Потенциальные риски

1. **Увеличение количества результатов**
   - Префиксный поиск может возвращать больше результатов для коротких запросов
   - Митигация: корректное ранжирование обеспечит, что наиболее релевантные результаты будут первыми

2. **Сложность настройки весов**
   - Подбор оптимальных весов может потребовать итеративного тестирования
   - Митигация: начальные веса будут основаны на логических рассуждениях, затем будут скорректированы на основе реального использования

3. **Производительность**
   - Дополнительные вычисления для ранжирования могут увеличить время ответа
   - Митигация: использование существующих индексов и оптимизация SQL запросов

### Ограничения

1. Поиск по части слова в середине названия не будет поддерживаться (только префиксный поиск)
2. Поиск опечаток не будет поддерживаться (только точные и префиксные совпадения)
3. Семантический поиск (по смыслу) не будет поддерживаться

## План реализации

1. Реализовать префиксный поиск для всех поисковых запросов
2. Добавить вычисление бонусов за точные совпадения
3. Добавить вычисление бонусов за совпадения в начале названия
4. Интегрировать бонусы в алгоритм ранжирования
5. Настроить веса для разных полей и типов совпадений
6. Написать тесты для проверки корректности ранжирования
7. Протестировать с реальными данными и скорректировать веса при необходимости
8. Обновить документацию

## Критерии успеха

1. Поиск по части слова работает корректно для всех выявленных сценариев
2. Ранжирование результатов соответствует ожиданиям пользователей
3. Время ответа остается в приемлемых пределах
4. Все существующие тесты продолжают проходить
5. Новые тесты покрывают основные сценарии использования улучшенного поиска
